<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Búsqueda de Documentos</title>
  <style>
    .relative { position: relative; }
    #suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 .375rem .375rem;
      max-height: 12rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      display: none;
      z-index: 9999;
    }
    #suggestions div:hover { background-color: #f3f4f6; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start p-4 sm:p-6">
  <div class="w-full max-w-3xl bg-white rounded-2xl shadow-lg overflow-visible">

    <!-- ENCABEZADO DINÁMICO -->
    <div class="px-6 pt-6 pb-4 text-center">
      <img id="logo" src="" alt="Logo" class="mx-auto h-20 sm:h-24 mb-6" />
      <p class="text-gray-800 text-base sm:text-lg mb-3 font-medium">
        Estimados clientes y autoridades competentes:
      </p>
      <p id="descripcion" class="text-gray-700 text-sm sm:text-base mb-4 leading-relaxed italic"></p>
      <p class="text-gray-800 text-base sm:text-lg font-semibold mb-1">
        Modo de uso:
      </p>
      <div id="instrucciones"></div>
    </div>

    <!-- BÚSQUEDA POR CÓDIGO -->
    <div class="border-t">
      <div class="p-6 sm:p-8">
        <h2 class="text-2xl sm:text-3xl font-semibold mb-4">Búsqueda por Código</h2>
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mb-4">
          <div class="relative flex-1">
            <input
              id="codeInput"
              type="text"
              placeholder="Código a buscar"
              class="w-full sm:flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-300"
            />
            <div id="suggestions"></div>
          </div>
          <button id="btnCodeSearch" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition text-center">
            Buscar
          </button>
          <button id="btnCodeClear" class="w-full sm:w-auto bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg transition text-center">
            Limpiar
          </button>
        </div>
        <div id="code-alert" class="mb-4 text-red-600 font-medium"></div>
        <div id="results-code" class="space-y-4"></div>
      </div>
    </div>

  </div>

  <!-- FOOTER DINÁMICO -->
  <footer id="footer" class="w-full max-w-3xl mt-6 text-center text-gray-600 text-sm">
    <div class="mt-4">
      <button onclick="toggleLegalModal()" class="text-red-600 hover:underline font-medium">Aviso Legal</button>
    </div>
  </footer>

  <!-- MODAL AVISO LEGAL -->
  <div id="legalModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white max-w-md w-full p-6 rounded-xl shadow-lg relative">
      <button onclick="toggleLegalModal()" class="absolute top-2 right-3 text-gray-500 hover:text-red-600 text-xl">&times;</button>
      <h2 class="text-lg font-bold text-gray-800 mb-3">Aviso Legal</h2>
      <p id="avisoLegalTexto" class="text-sm text-gray-700 leading-relaxed"></p>
    </div>
  </div>

  <script>
    // Detectar cliente desde la URL
    const urlParams = new URLSearchParams(window.location.search);
    const pathSegments = window.location.pathname.split('/').filter(Boolean);
    const CLIENTE_SLUG = urlParams.get('cliente') || pathSegments[pathSegments.indexOf('bc') + 1] || 'kino';
    
    const api = '../../api.php';
    let CONFIG = null;
    let fullList = [];

    // Cargar configuración y datos
    (async function() {
      try {
        // Cargar config
        const configRes = await fetch(`${api}?action=get_config&cliente=${CLIENTE_SLUG}`);
        CONFIG = await configRes.json();
        
        if (CONFIG.error) {
          document.getElementById('code-alert').innerText = 'Error: ' + CONFIG.error;
          return;
        }

        // Aplicar configuración visual
        const pub = CONFIG.publico;
        document.getElementById('logo').src = pub.logo;
        document.getElementById('logo').alt = CONFIG.nombre;
        document.getElementById('descripcion').textContent = pub.descripcion;
        
        // Instrucciones
        const inst = pub.instrucciones;
        document.getElementById('instrucciones').innerHTML = `
          <p class="text-gray-700 text-sm sm:text-base mb-1 leading-relaxed">${inst.paso1}</p>
          <p class="text-gray-700 text-sm sm:text-base mb-1 leading-relaxed">${inst.paso2}</p>
          <p class="text-gray-700 text-sm sm:text-base mb-1 leading-relaxed">${inst.paso3}</p>
          <p class="text-gray-700 text-sm sm:text-base leading-relaxed">${inst.paso4}</p>
        `;

        // Footer
        const foot = pub.footer;
        document.getElementById('footer').innerHTML = `
          <p class="mb-1">${foot.descripcion}</p>
          <p class="mb-1">${foot.ubicacion}</p>
          <p class="mb-1">
            Línea de Atención:
            <a href="https://wa.me/${foot.whatsapp}" target="_blank" class="text-red-600 font-medium hover:underline">${foot.telefono}</a>
          </p>
          <p>
            <a href="${foot.web}" target="_blank" class="text-red-600 hover:underline">${foot.web}</a>
          </p>
          <div class="mt-4">
            <button onclick="toggleLegalModal()" class="text-red-600 hover:underline font-medium">Aviso Legal</button>
          </div>
        `;

        // Aviso legal
        document.getElementById('avisoLegalTexto').innerHTML = pub.aviso_legal;

        // Cargar lista completa
        const listRes = await fetch(`${api}?action=list&cliente=${CLIENTE_SLUG}&page=1&per_page=0`);
        const listData = await listRes.json();
        fullList = listData.data || [];

      } catch (e) {
        document.getElementById('code-alert').innerText = 'Error de conexión al servidor.';
        console.error(e);
      }
    })();

    // Autocompletado
    const codeInput = document.getElementById('codeInput');
    const suggestions = document.getElementById('suggestions');
    let timeoutId;

    codeInput.addEventListener('input', () => {
      clearTimeout(timeoutId);
      const term = codeInput.value.trim().toUpperCase();
      if (!term) { 
        suggestions.style.display = 'none'; 
        return; 
      }
      timeoutId = setTimeout(async () => {
        try {
          const res = await fetch(`${api}?action=suggest&cliente=${CLIENTE_SLUG}&term=${encodeURIComponent(term)}`);
          const arr = await res.json();
          if (!arr.length) { 
            suggestions.style.display = 'none'; 
            return; 
          }
          suggestions.innerHTML = arr.map(c => `<div class="px-4 py-2 cursor-pointer" data-code="${c}">${c}</div>`).join('');
          suggestions.style.display = 'block';
        } catch {
          suggestions.style.display = 'none';
        }
      }, 200);
    });

    suggestions.addEventListener('touchmove', e => { e.stopPropagation(); });

    suggestions.addEventListener('click', e => {
      const code = e.target.dataset.code;
      if (!code) return;
      codeInput.value = code;
      suggestions.style.display = 'none';
      doCodeSearch();
    });

    codeInput.addEventListener('blur', () => setTimeout(() => suggestions.style.display = 'none', 100));

    // Búsqueda
    const alertBox = document.getElementById('code-alert');
    const results = document.getElementById('results-code');

    function renderResults(items) {
      if (!items.length) {
        results.innerHTML = '<p class="text-gray-500">No hay documentos para este código.</p>';
        return;
      }
      results.innerHTML = items.map(d => `
        <div class="border rounded-lg p-4 bg-white shadow-sm">
          <h3 class="font-semibold text-lg truncate">${d.name}</h3>
          <p class="text-sm text-gray-600 mt-1 truncate">${d.date}</p>
          <p class="text-xs text-gray-500 italic mt-0.5 truncate">${d.path}</p>
          <a href="../../uploads/${CLIENTE_SLUG}/${d.path}" target="_blank" class="text-red-600 hover:underline mt-1 inline-block font-semibold">Ver PDF</a>
        </div>
      `).join('');
    }

    window.doCodeSearch = () => {
      const code = codeInput.value.trim().toUpperCase();
      alertBox.innerText = '';
      results.innerHTML = '';
      if (!code) return;
      const matched = fullList.filter(d => d.codes.some(c => c.toUpperCase() === code));
      if (!matched.length) {
        alertBox.innerText = `No hay documentos con "${code}".`;
        return;
      }
      renderResults(matched);
    };

    document.getElementById('btnCodeSearch').onclick = doCodeSearch;
    
    document.getElementById('btnCodeClear').onclick = () => {
      codeInput.value = '';
      alertBox.innerText = '';
      results.innerHTML = '';
      suggestions.style.display = 'none';
    };

    function toggleLegalModal() { 
      document.getElementById('legalModal').classList.toggle('hidden'); 
    }
  </script>
</body>
</html>